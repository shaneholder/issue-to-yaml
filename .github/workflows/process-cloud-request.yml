name: Process Cloud Environment Request

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  assign-copilot-agent:
    name: Assign Copilot Agent to Convert Issue
    runs-on: ubuntu-latest
    
    # Only run for issues with the cloud-request label
    if: contains(github.event.issue.labels.*.name, 'cloud-request')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Assign Copilot coding agent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            
            console.log(`Processing cloud environment request issue #${issueNumber}`);
            
            // Assign the issue to Copilot
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              assignees: ['Copilot']
            });
            
            // Add a comment with instructions for the Copilot agent
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `Please use the \`convert-issue-to-yaml\` agent to convert this cloud environment request to a YAML file.
              
              Parse the issue body and generate a validated YAML file following the schema at \`schemas/cloud-environment-request.schema.json\`.
              
              Save the output to the \`requests/\` directory with the filename format: \`<application-name>-${issueNumber}.yaml\``
            });
            
            // Add a processing label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['copilot-processing']
            });
            
            console.log(`Copilot agent assigned to issue #${issueNumber}`);
